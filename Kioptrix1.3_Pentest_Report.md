# Application Penetration Testing Report Kioptrix-v1.3


## Introduction and Objectives

The application penetration testing report contains efforts that were conducted to find vulnerabilities, which a threat actor can use to gain control over the web application. For the scope of this penetration test, the web application was deployed in the Virtualized Environment with no additional information about the system.

IP address: **192.168.23.131**

The assumption with severity calculation was made that the system is intended to go public soon.

## Summary


### High-Level Summary

This chapter presents a high overview of the results found during the application penetration test.
The chart and table below present the findings with the corresponding severity.

![VULN_SEV_KIOPTRIX](../master/static/barchart_kioptrix.png)

Vulnerabilities with critical severity allow the attacker to remotely execute code on the system or to leak data with an extremely high likelihood to exploit e.g. Internet-facing application without authentication. Vulnerabilities with severity high allow the attacker to take over the account, leak data with relatively high likelihood to exploit. Vulnerabilities with severity medium can lead to eavesdropping of the communication between client and application, secret leakage and denial of service. Vulnerabilities with severity low can assist in the exploitation of higher severity vulnerabilities.
For further reading, there were CWE-ID provided.


|No.|Vulnerability                                    |Severity        |CWE-ID        |
|---|-------------                                    |--------        |------        |
|1    |SQL Injection                                    |**Critical**    |CWE-89        |
|2    |Local File Inclusion                            |**High**         |CWE-98        |
|3    |Weak Passwords                                    |Medium            |CWE-521    |
|4    |Cleartext Storage of Passwords                    |Medium            |CWE-312    |
|5    |Unencrypted communication                        |Medium            |CWE-319    |
|6    |HTTP TRACE Enabled                                |Low            |CWE-749    |
|7    |Anti-Clickjacking not presents                    |Low            |CWE-1021    |
|8    |Cookie without httponly flag                    |Low            |CWE-1004    |
|9    |Information exposure through directory path    |Low            |CWE-200    |

For the detailed description of each vulnerability, please refer to CWE-ID.


### Detailed Summary

This chapter presents a detailed summary of vulnerable endpoints. The chapter is more dedicated to technical people who are interested in the remediation process. The table below presents the vulnerable HTTP endpoints with the HTTP method, parameters, and Body.


|No.|Vulnerable Endpoint    |HTTP METHOD|Params            |Body                                               |
|---|-------------------    |-----------|------            |----                                             |
|1    |/checklogin.php        |POST        |-               |myusername=test&mypassword=**test**&Submit=Login|
|2    |/member.php            |GET        |**username**    |-                                                 |

For remaining vulnerabilities, there are no vulnerable parameters or body but weakness lays in webserver configuration, HTTP header or general policy.

**Numbers 3 and 4** - refers to weak password policy

**Number 5** - Unencrypted communication refers to sending sensitive data (username and password) over an unencrypted channel. When implementing the encryption in transit, appropriate HTTP headers should be set up to ensure the strong configuration of Http over TLS. The details can be found in Recommendation chapter.

**Number 6** - HTTP Trace Enabled refers to the HTTP method (Trace) that reflects the input sent by the user. The vulnerability allows the attacker to bypass native browser cookie protection (if in place e.g. httponly), to leak the sensitive cookie by Cross-site scripting attack.

**Number 7** - vulnerability allows the attacker to render the content of the website in the context of other domain owned by the attacker. Unless intended as functionality, appropriate HTTP Header has to be set up to limit the rendering of the website in the different browser context.

**Number 8** - the cookie missing httponly flag which in case of Cross-site scripting attack allow the attacker to easily hijack the cookie and take over user session.

**Number 9** - the information is exposed through the directory names in the web application.

## Methodology

The testing methodology used was based on OWASP Application Security Verification Standard 4.0


### Information Gathering & Service Enumeration

To identify the open ports and running services the Nmap scan was run with NSE scripts.

```
root@kali:~# nmap -sS -sV -T4 -A 192.168.23.131
Starting Nmap 7.80 ( https://nmap.org ) at 2019-08-22 10:38 CEST
Nmap scan report for 192.168.23.131
Host is up (0.00062s latency).
Not shown: 566 closed ports, 430 filtered ports
PORT    STATE SERVICE     VERSION
22/tcp  open  ssh         OpenSSH 4.7p1 Debian 8ubuntu1.2 (protocol 2.0)
| ssh-hostkey:
|   1024 9b:ad:4f:f2:1e:c5:f2:39:14:b9:d3:a0:0b:e8:41:71 (DSA)
|_  2048 85:40:c6:d5:41:26:05:34:ad:f8:6e:f2:a7:6b:4f:0e (RSA)
80/tcp  open  http        Apache httpd 2.2.8 ((Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch)
|_http-server-header: Apache/2.2.8 (Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch
|_http-title: Site doesn't have a title (text/html).
139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp open  netbios-ssn Samba smbd 3.0.28a (workgroup: WORKGROUP)
MAC Address: 00:0C:29:DA:92:E7 (VMware)
Device type: general purpose
Running: Linux 2.6.X
OS CPE: cpe:/o:linux:linux_kernel:2.6
OS details: Linux 2.6.9 - 2.6.33
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
Host script results:
|_clock-skew: mean: 3h59m59s, deviation: 2h49m42s, median: 1h59m59s
|_nbstat: NetBIOS name: KIOPTRIX4, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| smb-os-discovery:
|   OS: Unix (Samba 3.0.28a)
|   Computer name: Kioptrix4
|   NetBIOS computer name:
|   Domain name: localdomain
|   FQDN: Kioptrix4.localdomain
|_  System time: 2019-08-22T06:38:46-04:00
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
|_smb2-time: Protocol negotiation failed (SMB2)

TRACEROUTE
HOP RTT     ADDRESS
1   0.62 ms 192.168.23.131

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 20.55 seconds
```

There are 4 TCP ports open on the machine. On port 22 TCP there is ssh service running. Port 80 TCP, exposed and outdated Apache server running. On ports 139 and 445 TCP, there is Samba SMB service running. Also, Nmap has identified the operating system version as Linux kernel 2.6. The next target would be the Http service on port 80 TCP.


```
root@kali:~# nikto -host http://192.168.23.131
- Nikto v2.1.6
---------------------------------------------------------------------------
+ Target IP:          192.168.23.131
+ Target Hostname:    192.168.23.131
+ Target Port:        80
+ Start Time:         2019-08-22 10:10:36 (GMT2)
---------------------------------------------------------------------------
+ Server: Apache/2.2.8 (Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch
+ Retrieved x-powered-by header: PHP/5.2.4-2ubuntu5.6
+ The anti-clickjacking X-Frame-Options header is not present.
+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS
+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type
+ Uncommon header 'tcn' found, with contents: list
+ Apache mod_negotiation is enabled with MultiViews, which allows attackers to easily brute force file names. See http://www.wisec.it/sectou.php?id=4698ebdc59d15. The following alternatives for 'index' were found: index.php
+ Apache/2.2.8 appears to be outdated (current is at least Apache/2.4.37). Apache 2.2.34 is the EOL for the 2.x branch.
+ PHP/5.2.4-2ubuntu5.6 appears to be outdated (current is at least 7.2.12). PHP 5.6.33, 7.0.27, 7.1.13, 7.2.1 may also current release for each branch.
+ Web Server returns a valid response with junk HTTP methods, this may cause false positives.
+ OSVDB-877: HTTP TRACE method is active, suggesting the host is vulnerable to XST
+ OSVDB-12184: /?=PHPB8B5F2A0-3C92-11d3-A3A9-4C7B08C10000: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-12184: /?=PHPE9568F36-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-12184: /?=PHPE9568F34-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-12184: /?=PHPE9568F35-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-3268: /icons/: Directory indexing found.
+ OSVDB-3268: /images/: Directory indexing found.
+ Server may leak inodes via ETags, header found with file /icons/README, inode: 98933, size: 5108, mtime: Tue Aug 28 12:48:10 2007
+ OSVDB-3233: /icons/README: Apache default file found.
+ Cookie PHPSESSID created without the httponly flag
+ 8724 requests: 0 error(s) and 19 item(s) reported on remote host
+ End Time:           2019-08-22 10:11:09 (GMT2) (33 seconds)
---------------------------------------------------------------------------
+ 1 host(s) tested

```

At this moment the Nikto scan has identified the following vulnerabilities: communication is not encrypted (number 5), HTTP Trace method is active (number 6), Anti-clickjacking header is not present (number 7), Cookie PHPSESSID created without the httponly flag (number 8).

Also please note that nikto discover **outdated** version of PHP and Apache.

To enumerate directories/files in the web application dirb will be used.
```
root@kali:~# dirb http://192.168.23.131
-----------------
DIRB v2.22   
By The Dark Raver
-----------------
START_TIME: Thu Aug 22 11:11:15 2019
URL_BASE: http://192.168.23.131/
WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt
-----------------
GENERATED WORDS: 4612                                                         
---- Scanning URL: http://192.168.23.131/ ----
+ http://192.168.23.131/cgi-bin/ (CODE:403|SIZE:329)                          
==> DIRECTORY: http://192.168.23.131/images/                                  
+ http://192.168.23.131/index (CODE:200|SIZE:1255)                            
+ http://192.168.23.131/index.php (CODE:200|SIZE:1255)                        
==> DIRECTORY: http://192.168.23.131/john/                                    
+ http://192.168.23.131/logout (CODE:302|SIZE:0)                              
+ http://192.168.23.131/member (CODE:302|SIZE:220)                            
+ http://192.168.23.131/server-status (CODE:403|SIZE:334)                     

---- Entering directory: http://192.168.23.131/images/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                       
    (Use mode '-w' if you want to scan it anyway)
 
---- Entering directory: http://192.168.23.131/john/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                       
    (Use mode '-w' if you want to scan it anyway)
-----------------
END_TIME: Thu Aug 22 11:11:19 2019
DOWNLOADED: 4612 - FOUND: 61
```

The valuable information from the dirb scan is that potentially there is a user **john** register in the web application which corresponds to **number 9** vulnerability.

### Testing and Exploitation

Further testing will be handled on the Http website running on port 80 TCP. Then the communication was intercepted with the usage of local web proxy Burp Suite. This is how the main page looks like.

![MAIN](../master/static/kioptrix_main.jpg)

Since we have identified that the user john is valid, we may try to login to the application by sending the following POST request.

```
POST /checklogin.php HTTP/1.1
Host: 192.168.23.131
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://192.168.23.131/
Content-Type: application/x-www-form-urlencoded
Content-Length: 44
Cookie: PHPSESSID=46338c8d8f8b18d8ece9ae9088156bc6
Connection: close
Upgrade-Insecure-Requests: 1
 
myusername=john&mypassword=test&Submit=Login


```

The authentication failed. At this point, the attacker will try to bypass authentication to continue the testing. The following payload was sent to the webserver to check for SQL injection vulnerability.

```
POST /checklogin.php HTTP/1.1
Host: 192.168.23.131
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://192.168.23.131/
Content-Type: application/x-www-form-urlencoded
Content-Length: 44
Cookie: PHPSESSID=46338c8d8f8b18d8ece9ae9088156bc6
Connection: close
Upgrade-Insecure-Requests: 1
 
myusername=john&mypassword=%27+OR+%27%27%3D%27&Submit=Login


```

The payload resulted in successful login and redirection to the user page. Where we can see the username and password, which is already a sign of vulnerability **number 4**.

![USER](../master/static/kioptrix_userpage.jpg)

Since the SQL injection vulnerability was identified the attacker would try to extract as much information as possible from the web application. For database dumping, there maybe be an automated tool used called sqlmap. The sqlmap will dump all the necessary data from the database. During the penetration testing, there was the **members** table dumped.

![MEMBERS](../master/static/kioptrix_members.jpg)

At this point we can have discovered the vulnerabilities **number 3 and 4**, the passwords were stored in the plaintext and also the password policy was not enforced, the password of user john is rather weak and can be easily brute-forced.

The discovered credentials have been checked for authentication through ssh service running on port 22 TCP. As presented below, the credentials have given access to the restricted shell which was easily escaped to the full bash shell.

![SSH_ROBERT](../master/static/kioptrix_ssh_robert.jpg)

At this point, the severity of SQL Injection vulnerability can be stated as **critical**, since it allows for remote code execution, without previous authentication/authorization.

Then, the testing has continued to discover new vulnerabilities remaining in web application.

One can see that there is a parameter username=john supplied in HTTP GET request. From the previous **dirb** scan the attacker knows that there is john.php and from the Nikto scan we know that \*.php extensions are mapped to no extensions. At this point, we can assume that the application takes the input from the user and injects the template to the execute PHP code. The best way to check if a vulnerability exists is to check if it is possible to read some files from the disk e.g. /etc/passwd.

![ETC](../master/static/kioptrix_etc.jpg)

It seems that the application cuts off the /etc, the attacker might try to duplicate /etc.


![ETC2](../master/static/kioptrix_etc2.jpg)

Now, it seems that the application appends .php at the end of the file path. To end the string before .php is appended, one must submit the NULL byte indicating that the string has ended.

![ETC3](../master/static/kioptrix_etc3.jpg)

At this point, the attacker can read any file from the disk with the privileges of a web application. The attacker might also look for ways to leverage the vulnerability to achieve the remote code execution. With the possibility to read any files from the disk, to execute PHP code one need to upload the code anywhere in the disk.

Luckily in Linux, we have got the concept that everything is a file. Saying there are pseudo files on the disk that are mapped to certain spaces in the memory, we can find those files in /proc directory. Additional the pseudo folder self is the pointer to the memory of the current process.


![PROC](../master/static/kioptrix_proc.jpg)

At this point, the attacker will try to brute force the appropriate PID. One may use the Intruder feature to achieve that.

![INTRUDER](../master/static/kioptrix_proc2.jpg)

one may say that PID 9 has significantly lower length than other PIDs.Here is how the content looks like.

![PROC](../master/static/kioptrix_proc3.jpg)

So the data from the previous request in the same session has been saved to the pseudo-file on the disk. This is the input fully control by the attacker. To prove the exploitation, the following PHP code will be executed.

```
<?php phpinfo(); ?>
```

The payload has been URL encoded to ensure proper delivery and interpretation by the webserver.

![PHPINFO](../master/static/kioptrix_phpinfo.jpg)

The vulnerability was assigned with severity **high** since it requires the previous authentication.


### Appendix - Privilage Escalation

After achieving a low privileged user shell in the OS. The attacker will look for privilege escalation. From the discovery phase, we know that it is possible to run the kernel exploit, however, it is recommended to look for wrongly configured services, cronjobs, processes with wrongly set permissions, setuid files since the kernel exploits might affect the availability of services.

The attacker found out that there is a mysqld process running as with root permission.

![Mysql1](../master/static/kioptrix_mysql1.jpg)

Also in the web application configuration files, the attacker found the login to MySQL root account.

![Mysql2](../master/static/kioptrix_mysql2.jpg)

With that knowledge, the attacker might easily log in to MySQL running on localhost with MySQL user root credentials and use builtin MySQL function to execute system commands with the privileges of currently running process. The attacker can change the permissions of currently login user by adding it to an admin group or create a new user in a system with admin privileges.

![Mysql3](../master/static/kioptrix_mysql3.jpg)
The attacker can log in as root, the server has been fully compromised.
![Root](../master/static/kioptrix_root.jpg)

## Recommendations

The last chapter describes the recommendation for remediation of each discovered vulnerability. Additionally, there has been some enhancement proposed to ensure the highest risk mitigation.

**1. SQL Injection**

Use prepared statements and parameterized queries. These are SQL statements that are sent to and parsed by the database server separately from any parameters. This way it is impossible for an attacker to inject malicious SQL.
Example using PDO (for any supported database driver):

```
$stmt = $pdo->prepare('SELECT * FROM employees WHERE name = :name');

$stmt->execute(array('name' => $name));
```

**2. Local File Inclusion**

To protect the application from this weakness it is advised to follow these instructions:

Never use attacker-controlled data as a filename or part of the filename when including files. If the inclusion of a file should be based on the user's choice, use preset conditions instead of using filenames.
Perform whitelist checks when including files using user-controlled input.
Use sandbox environments (e.g. jail, chroot) that enforce strict boundaries between the process and the operating system.
Use PHP configuration to limit the attack surface. Turn off the allow_url_fopen option which limits the ability to include files from a remote location.
As a temporary solution, we strongly recommend blocking access to vulnerable script until the issue is resolved. This can be achieved either using native functionality of the webserver or changing system access permission to file.


**3. Weak Passwords**

Enforce a password policy for the users. Do not allow users to create an account with weak passwords. Regularly audit user passwords.


**4.Cleartext Storage of Passwords**

Never store user passwords in cleartext. Use secure hashing functions with salt. For details refer to PHP guideline:
https://www.php.net/manual/en/faq.passwords.php

**5. Unencrypted communication**

Implement strong TLS configuration, send sensitive data only through an encrypted channel. The tester recommends applying TLS1.2+ (date: 22/08/2019). Also, it is recommended to set up HSTS-HTTP header and add the flag secure to the sensitive cookie.

**6. HTTP TRACE Enabled**

Disable HTTP TRACE method in Apache configuration. There should be the following line added to httpd.conf
```
TraceEnable Off
```

**7. Anti-Clickjacking not presents**

Apply the UI render restriction by adding X-Frame-Options header to each response. There should be the following line added to httpd.conf

```
Header always append X-Frame-Options SAMEORIGIN
```

**8. Cookie without httponly flag**

Protect the sensitive cookie by applying the flag HttpOnly. The flag should be appended in the time for cookie creation in PHP code.


**9. Information exposure through directory path**

The information about the usernames is disclosed by filename (e.g.john.php). Do not use the username to create user-related files/scripts.


**10. Additional**

- Implement a patch management policy. Regularly apply software updates. Upgrade Apache Webserver, PHP, Linux Kernel.

- Enable X-XSS-Protection Header

- Enable X-Content-Type-Options

- Use low privileged user to run MySQL service
