# Application Penetration Testing Report Kioptrix-v1.3


## Intoduction and Objectives

The application penetration testing report contains efforts that were conducted in order to find vulnerabilities, which a threat actor can use to gain control over the web application. For the scope of this penetration test, the web application was deployed in the Virualized Enviorement with no additional information about the system.

IP address: **192.168.23.132**

The assumption with severity calculation was made that the system is intended to go public soon.

## Summary


### High-Level Summary

This chapter presents the high overview of the results found during the application penetration test.
The chart and table below presents the findings with the coresponding severity.

![VULN_SEV_SQLi2shell](../master/static/barchart_sqli.png)

Vulnerabilities with critical severity allow the attacker to remotely execute code on the system or to leak  data with extremly high likehood to exploit e.g. Internet facing application without authentication. Vulnerabilities with severity high allow the attacker to take over the account, leak data with relativly high likelihood to exploit. Vulnerabilities with severity medium can lead to eavasdropping of the communication between client and application, secret leakage and denial of service. Vulnerabilities with severity low can assist in exploitation of higher severity vulnerabilities.
For further reading there were CWE-ID provided.


|No.|Vulnerability									|Severity		|CWE-ID		|
|---|-------------									|--------		|------		|
|1	|SQL Injection									|**HIGH**		|CWE-89		|
|2	|Unrestricted File Upload						|**High** 		|CWE-434	|
|3	|Weak Passwords									|Medium			|CWE-521	|
|4	|Unencrypted communication						|Medium			|CWE-319	|
|5	|HTTP TRACE Enabled								|Low			|CWE-749	|
|6	|Anti-Clickjacking not presents					|Low			|CWE-1021	|
|7	|Cookie without httponly flag					|Low			|CWE-1004	|

For the detailed description of each vulnerability, please refer to CWE-ID.


### Detailed Summary

This chapter presents the detailed summary of vulnerable endpoints. The chapter is more dedicated to technical people who are interested in remediation process. Table below presents the vulnerable HTTP endpoints with the HTTP method, parameters and Body.


|No.|Vulnerable Endpoint	|HTTP METHOD|HTTP Header					|Body		|
|---|-------------------	|-----------|-----------					|----		|
|1	|/cat.php?id=1			|GET		|X-Forwarded-For: **<VULN>**	|-			|
|2	|/admin/index.php		|POST		|-								|**<VULN>**	|

For remaining vulnerabilities, there are no vulnerable parameters or body but weakness lays in webserver configuration, HTTP header or general policy.

**Numbers 3** - refers to weak password policy

**Number 4** - Unencrypted communication refers to sending sensitive data (username and password) over unencrypted channel. When implementing the encryption in transit, appropiate HTTP headers should be set up to ensure the strong configuration of Http over tls. The details can be found in Recommendation chapter.

**Number 5** - HTTP Trace Enabled refers to HTTP method (Trace) that refelects the input send by the user. The vulnerability allows the attacker to bypass native browser cookie protection (if in place e.g. httponly), to leak the senstive cookie by Cross-site scripting attack.

**Number 6** - vulnerability allows the attacker to render content of the website in the context of other domain owned by attacker. Unless intended as functionallity, appropiate HTTP Header has to be set up to limit the rendering of the website in different browser context.

**Number 7** - the cookie missing httponly flag which in case of Cross-site scripting attack allow the attacker to easly hijack the cookie and take over user session.


## Methodology

The testing methodology used was based on OWASP Applcation Security Verification Standard 4.0


### Information Gathering & Service Enumeration

To idetify the open ports and running services the nmap scan was run with NSE scripts.

```
root@kali:~# nmap -sS -sV -T4 -A 192.168.23.132
Starting Nmap 7.80 ( https://nmap.org ) at 2019-08-22 15:38 CEST
Nmap scan report for 192.168.23.132
Host is up (0.00084s latency).
Not shown: 999 closed ports
PORT   STATE SERVICE VERSION
80/tcp open  http    nginx 0.7.67
|_http-server-header: nginx/0.7.67
|_http-title: My Photoblog - latest picture
MAC Address: 00:0C:29:22:BE:32 (VMware)
Device type: general purpose
Running: Linux 2.6.X
OS CPE: cpe:/o:linux:linux_kernel:2.6.32
OS details: Linux 2.6.32
Network Distance: 1 hop
TRACEROUTE
HOP RTT     ADDRESS
1   0.84 ms 192.168.23.132

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 8.57 seconds
```

There is only 1 tcp port open on the machine. Port 80 tcp, exposed nginx webserver server running. Also, nmap has identified the operating system version as Linux kernel 2.6.32 The next target would be the http service on port 80 tcp.


```
root@kali:~# nikto -host http://192.168.23.132

- Nikto v2.1.6
---------------------------------------------------------------------------
+ Target IP:          192.168.23.132
+ Target Hostname:    192.168.23.132
+ Target Port:        80
+ Start Time:         2019-08-22 15:39:34 (GMT2)
---------------------------------------------------------------------------
+ Server: nginx/0.7.67
+ Retrieved x-powered-by header: PHP/5.3.3-7+squeeze15
+ The anti-clickjacking X-Frame-Options header is not present.
+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS
+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type
+ No CGI Directories found (use '-C all' to force check all possible dirs)
+ Cookie PHPSESSID created without the httponly flag
+ OSVDB-5034: /admin/login.php?action=insert&username=test&password=test: phpAuction may allow user admin accounts to be inserted without proper authentication. Attempt to log in with user 'test' password 'test' to verify.
+ OSVDB-12184: /?=PHPB8B5F2A0-3C92-11d3-A3A9-4C7B08C10000: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-12184: /?=PHPE9568F36-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-12184: /?=PHPE9568F34-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-12184: /?=PHPE9568F35-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ /admin/login.php: Admin login page/section found.
+ ERROR: Error limit (20) reached for host, giving up. Last error:
+ Scan terminated:  19 error(s) and 11 item(s) reported on remote host
+ End Time:           2019-08-22 15:40:07 (GMT2) (33 seconds)
---------------------------------------------------------------------------
+ 1 host(s) tested
```

At this moment the nikto scan has idetify the following vulnerabilities: communication is not encrypted (number 4), HTTP Trace method is active (number 5), Anti-clickjacking header is not present (number 6).

To enumerate directories/files in the web application dirb will be used.
```
root@kali:~# dirb http://192.168.23.132
-----------------
DIRB v2.22   
By The Dark Raver
-----------------
START_TIME: Thu Aug 22 15:41:07 2019
URL_BASE: http://192.168.23.132/
WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt
-----------------
GENERATED WORDS: 4612                                                         
---- Scanning URL: http://192.168.23.132/ ----
==> DIRECTORY: http://192.168.23.132/admin/                                   
==> DIRECTORY: http://192.168.23.132/classes/                                 
==> DIRECTORY: http://192.168.23.132/css/                                     
+ http://192.168.23.132/favicon.ico (CODE:200|SIZE:14634)                     
==> DIRECTORY: http://192.168.23.132/images/                                  
+ http://192.168.23.132/index.php (CODE:200|SIZE:1367)                        
---- Entering directory: http://192.168.23.132/admin/ ----
+ http://192.168.23.132/admin/index.php (CODE:302|SIZE:0)                     
==> DIRECTORY: http://192.168.23.132/admin/uploads/     
---- Entering directory: http://192.168.23.132/classes/ 
---- Entering directory: http://192.168.23.132/css/ ----
---- Entering directory: http://192.168.23.132/images/ ----
---- Entering directory: http://192.168.23.132/admin/uploads/ ----
-----------------
END_TIME: Thu Aug 22 15:41:25 2019
DOWNLOADED: 27672 - FOUND: 3
```

At this moment we see that there is a file upload functionallity avaiable only for authenticated admin user. There is also a login form that allows admin to login.

### Testing and Exploitation

Further testing will be handled on the http website running on port 80 tcp. Then the communication was intercepted with the usage of local web proxy Burp Suite. This is how main page looks like.

![MAIN](../master/static/sqli_main.jpg)

![login](../master/static/sqli_login.jpg)

Initially, all the paremeters and body seems to be not vulnerable. However, some of the application stores (in a database) the HTTP headers like User-Agent, Referer, X-Forwarded-For or Cookie to indetify and track the users. To test for SQL injection the following request has been supplied to sqlmap.

```
GET /cat.php?id=* HTTP/1.1
Host: 192.168.23.132
User-Agent: *
Referer: *
X-Forwarded-For: *
Cookie: *
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Upgrade-Insecure-Requests: 1


```
Sqlmap detected the blind timebased SQL injection on the backend there is MySQL running. To confirm the following payload could be send in **X-Forwarded For** header.

```
---
Parameter: X-Forwarded-For #1* ((custom) HEADER)
    Type: time-based blind
    Title: MySQL >= 5.0.12 AND time-based blind (query SLEEP)
    Payload: ‘ AND (SELECT 8808 FROM (SELECT(SLEEP(5)))QLYW) AND ‘hIUq’=’hIUq
---
```

The sqlmap manage to retirve the username and hash of the password using timebased queries. The hash was retrived by simple dictonary attack.


![sqlmap](../master/static/sqli_sqlmap.jpg)


The credentials can be used to login to applcation. Please note that admin password is very weak and can be easly brute force, if no SQLi was found.

![upload](../master/static/sqli_upload.jpg)


## Recommendations

Last chapter describes the recommendation for remediation of each discovered vulnerability. Additionally there has been some enhancement proposed to ensure the highest risk mitigation.

**1. SQL Injection**

Use prepared statements and parameterized queries. These are SQL statements that are sent to and parsed by the database server separately from any parameters. This way it is impossible for an attacker to inject malicious SQL.
Example using PDO (for any supported database driver):

```
$stmt = $pdo->prepare('SELECT * FROM employees WHERE name = :name');

$stmt->execute(array('name' => $name));
```

**2. Unrestricted File Upload**

[TO BE WRITTEN]

**3. Weak Passwords**

Enforce password policy for the users. Do not allow users to create the account with weak passwords. Regulary audit user passwords.


**4. Unencrypted communication**

Implement strong TLS configuration, send senstive data only through encrypted channel. The tester recommends to apply TLS1.2+ (date: 22/08/2019). Also it is recommended to set up HSTS-HTTP header and add the flag secure to the sensitive cookie.

**5. HTTP TRACE Enabled**

Disbale HTTP TRACE method in Apache configuration. There should be following line added to httpd.conf
```
TraceEnable Off
```

**6. Anti-Clickjacking not presents**

Apply the UI render restriction by adding X-Frame-Options header to each response. There should be following line added to httpd.conf

```
Header always append X-Frame-Options SAMEORIGIN
```

**7. Cookie without httponly flag**

Protect the senstive cookie by applying the flag HttpOnly. The flag should be append in the time for cookie creation in PHP code.


**8. Additional**

- Implement patch management policy. Regulary apply software updates.

- Enable X-XSS-Protection Header

- Enable X-Content-Type-Options

- Add salt when hashing the password, use modern cryptographic function to generate password hashes.