# Application Penetration Testing Report Kioptrix-v1.3


## Intoduction and Objectives

The application penetration testing report contains efforts that were conducted in order to find vulnerabilities, which a threat actor can use to gain control over the web application. For the scope of this penetration test, the web application was deployed in the Virualized Enviorement with no additional information about the system.

IP address: **10.10.10.100**

The assumption with severity calculation was made that the system is intended to go public soon.

## Summary


### High-Level Summary

This chapter presents the high overview of the results found during the application penetration test.
The chart and table below presents the findings with the coresponding severity.

![VULN_SEV_KIOPTRIX](../master/static/barchart_pwnos.png)

Vulnerabilities with critical severity allow the attacker to remotely execute code on the system or to leak  data with extremly high likehood to exploit e.g. Internet facing application without authentication. Vulnerabilities with severity high allow the attacker to take over the account, leak data with relativly high likelihood to exploit. Vulnerabilities with severity medium can lead to eavasdropping of the communication between client and application, secret leakage and denial of service. Vulnerabilities with severity low can assist in exploitation of higher severity vulnerabilities.
For further reading there were CWE-ID provided.


|No.|Vulnerability									|Severity		|CWE-ID		|
|---|-------------									|--------		|------		|
|1	|SQL Injection									|**Critical**	|CWE-89		|
|2	|Using Vulnerable Software						|**Critical**	|-			|
|3	|Weak Passwords									|Medium			|CWE-521	|
|4	|Cleartext Storage of Passwords					|Medium			|CWE-312	|
|5	|Unecnrypted communication						|Medium			|CWE-319	|
|6	|Anti-Clickjacking not presents					|Low			|CWE-1021	|
|7	|Cookie without httponly flag					|Low			|CWE-1004	|

For the detailed description of each vulnerability, please refer to CWE-ID.


### Detailed Summary

This chapter presents the detailed summary of vulnerable endpoints. The chapter is more dedicated to technical people who are interested in remediation process. Table below presents the vulnerable HTTP endpoints with the HTTP method, parameters and Body.


|No.|Vulnerable Endpoint|HTTP METHOD|Params	|Body												  	 |
|---|-------------------|-----------|------	|----													 |
|1	|/login.php			|POST		|-   	|email=**vuln**&pass=test&submit=Login&submitted=TRUE 	 |

For remaining vulnerabilities, there are no vulnerable parameters or body but weakness lays in webserver configuration, HTTP header or general policy.

**Number 2** refers to the usage of vulnerable software. During the penetration test, the usage of Simple PHP Blog 0.4.0 was detected which is known to be vulnerable to remote code exuecution. 

**Numbers 3 and 4** - refers to weak password policy

**Number 5** - Unecrypted communication refers to sending sensitive data (username and password) over unencrypted channel. When implementing the encryption in transit, appropiate HTTP headers should be set up to ensure the strong configuration of Http over tls. The details can be found in Recommendation chapter.

**Number 6** - vulnerability allows the attacker to render content of the website in the context of other domain owned by attacker. Unless intended as functionallity, appropiate HTTP Header has to be set up to limit the rendering of the website in different browser context.

**Number 7** - the cookie missing httponly flag which in case of Cross-site scripting attack allow the attacker to easly hijack the cookie and take over user session.


## Methodology

The testing methodology used was based on OWASP Applcation Security Verification Standard 4.0


### Information Gathering & Service Enumeration

To idetify the open ports and running services the nmap scan was run with NSE scripts.

```
root@kali:~# nmap -sS -sV -T4 -A 10.10.10.100
Starting Nmap 7.70 ( https://nmap.org ) at 2019-08-23 05:42 EDT
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 10.10.10.100
Host is up (0.00066s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 5.8p1 Debian 1ubuntu3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   1024 85:d3:2b:01:09:42:7b:20:4e:30:03:6d:d1:8f:95:ff (DSA)
|   2048 30:7a:31:9a:1b:b8:17:e7:15:df:89:92:0e:cd:58:28 (RSA)
|_  256 10:12:64:4b:7d:ff:6a:87:37:26:38:b1:44:9f:cf:5e (ECDSA)
80/tcp open  http    Apache httpd 2.2.17 ((Ubuntu))
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
|_http-server-header: Apache/2.2.17 (Ubuntu)
|_http-title: Welcome to this Site!
MAC Address: 08:00:27:3D:16:A2 (Oracle VirtualBox virtual NIC)
Device type: general purpose
Running: Linux 2.6.X
OS CPE: cpe:/o:linux:linux_kernel:2.6
OS details: Linux 2.6.32 - 2.6.39
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.66 ms 10.10.10.100

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 8.44 seconds
```

There are 2 tcp ports open on the machine. On port 22 tcp there is ssh service running. Port 80 tcp, exposed and outdated apache server running. Also, nmap has identified the operating system version as Linux kernel 2.6. The next target would be the http service on port 80 tcp.


```
root@kali:~# nikto -h http://10.10.10.100
- Nikto v2.1.6
---------------------------------------------------------------------------
+ Target IP:          10.10.10.100
+ Target Hostname:    10.10.10.100
+ Target Port:        80
+ Start Time:         2019-08-23 05:44:04 (GMT-4)
---------------------------------------------------------------------------
+ Server: Apache/2.2.17 (Ubuntu)
+ Retrieved x-powered-by header: PHP/5.3.5-1ubuntu7
+ The anti-clickjacking X-Frame-Options header is not present.
+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS
+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type
+ Cookie PHPSESSID created without the httponly flag
+ Apache/2.2.17 appears to be outdated (current is at least Apache/2.4.12). Apache 2.0.65 (final release) and 2.2.29 are also current.
+ Uncommon header 'tcn' found, with contents: list
+ Apache mod_negotiation is enabled with MultiViews, which allows attackers to easily brute force file names. See http://www.wisec.it/sectou.php?id=4698ebdc59d15. The following alternatives for 'index' were found: index.php
+ Web Server returns a valid response with junk HTTP methods, this may cause false positives.
+ OSVDB-12184: /?=PHPB8B5F2A0-3C92-11d3-A3A9-4C7B08C10000: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-12184: /?=PHPE9568F36-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-12184: /?=PHPE9568F34-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-12184: /?=PHPE9568F35-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-3268: /includes/: Directory indexing found.
+ OSVDB-3092: /includes/: This might be interesting...
+ /info/: Output from the phpinfo() function was found.
+ OSVDB-3092: /info/: This might be interesting...
+ OSVDB-3092: /login/: This might be interesting...
+ OSVDB-3092: /register/: This might be interesting...
+ /info.php: Output from the phpinfo() function was found.
+ OSVDB-3233: /info.php: PHP is installed, and a test script which runs phpinfo() was found. This gives a lot of system information.
+ OSVDB-3268: /icons/: Directory indexing found.
+ Server leaks inodes via ETags, header found with file /icons/README, inode: 1311031, size: 5108, mtime: Tue Aug 28 06:48:10 2007
+ OSVDB-3233: /icons/README: Apache default file found.
+ /info.php?file=http://cirt.net/rfiinc.txt?: Output from the phpinfo() function was found.
+ OSVDB-5292: /info.php?file=http://cirt.net/rfiinc.txt?: RFI from RSnake's list (http://ha.ckers.org/weird/rfi-locations.dat) or from http://osvdb.org/
+ /login.php: Admin login page/section found.
+ 8310 requests: 0 error(s) and 27 item(s) reported on remote host
+ End Time:           2019-08-23 05:44:15 (GMT-4) (11 seconds)
---------------------------------------------------------------------------
```

At this moment the nikto scan has idetify the following vulnerabilities: communication is not encrypted (number X), Anti-clickjacking header is not present (number 7), Cookie PHPSESSID created without the httponly flag (number X).

Also please note that nikto discover **outdated** version of PHP and Apache.

To enumerate directories/files in the web application dirb will be used.
```
root@kali:~# dirb http://10.10.10.100

-----------------
DIRB v2.22    
By The Dark Raver
-----------------

START_TIME: Fri Aug 23 05:45:10 2019
URL_BASE: http://10.10.10.100/
WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt

-----------------

GENERATED WORDS: 4612                                                          

---- Scanning URL: http://10.10.10.100/ ----
+ http://10.10.10.100/activate (CODE:302|SIZE:0)                               
==> DIRECTORY: http://10.10.10.100/blog/                                       
+ http://10.10.10.100/cgi-bin/ (CODE:403|SIZE:288)                             
==> DIRECTORY: http://10.10.10.100/includes/                                   
+ http://10.10.10.100/index (CODE:200|SIZE:854)                                
+ http://10.10.10.100/index.php (CODE:200|SIZE:854)                            
+ http://10.10.10.100/info (CODE:200|SIZE:50171)                               
+ http://10.10.10.100/info.php (CODE:200|SIZE:50040)                           
+ http://10.10.10.100/login (CODE:200|SIZE:1174)                               
+ http://10.10.10.100/register (CODE:200|SIZE:1562)                            
+ http://10.10.10.100/server-status (CODE:403|SIZE:293)                        
                                                                               
---- Entering directory: http://10.10.10.100/blog/ ----
+ http://10.10.10.100/blog/add (CODE:302|SIZE:0)                               
+ http://10.10.10.100/blog/atom (CODE:200|SIZE:1062)                           
+ http://10.10.10.100/blog/categories (CODE:302|SIZE:0)                        
+ http://10.10.10.100/blog/comments (CODE:302|SIZE:0)                          
==> DIRECTORY: http://10.10.10.100/blog/config/                                
+ http://10.10.10.100/blog/contact (CODE:200|SIZE:6001)                        
==> DIRECTORY: http://10.10.10.100/blog/content/                               
+ http://10.10.10.100/blog/delete (CODE:302|SIZE:0)                            
==> DIRECTORY: http://10.10.10.100/blog/docs/                                  
==> DIRECTORY: http://10.10.10.100/blog/flash/                                 
==> DIRECTORY: http://10.10.10.100/blog/images/                                
+ http://10.10.10.100/blog/index (CODE:200|SIZE:8094)                          
+ http://10.10.10.100/blog/index.php (CODE:200|SIZE:8094)                      
+ http://10.10.10.100/blog/info (CODE:302|SIZE:0)                              
+ http://10.10.10.100/blog/info.php (CODE:302|SIZE:0)                          
==> DIRECTORY: http://10.10.10.100/blog/interface/                             
==> DIRECTORY: http://10.10.10.100/blog/languages/                             
+ http://10.10.10.100/blog/login (CODE:200|SIZE:5750)                          
+ http://10.10.10.100/blog/logout (CODE:302|SIZE:0)                            
+ http://10.10.10.100/blog/options (CODE:302|SIZE:0)                           
+ http://10.10.10.100/blog/rdf (CODE:200|SIZE:1411)                            
+ http://10.10.10.100/blog/rss (CODE:200|SIZE:1237)                            
==> DIRECTORY: http://10.10.10.100/blog/scripts/                               
+ http://10.10.10.100/blog/search (CODE:200|SIZE:5034)                         
+ http://10.10.10.100/blog/setup (CODE:302|SIZE:0)                             
+ http://10.10.10.100/blog/static (CODE:302|SIZE:0)                            
+ http://10.10.10.100/blog/stats (CODE:200|SIZE:5392)                          
==> DIRECTORY: http://10.10.10.100/blog/themes/                                
+ http://10.10.10.100/blog/trackback (CODE:302|SIZE:0)                         
+ http://10.10.10.100/blog/upgrade (CODE:302|SIZE:0)                           
                                                                               
---- Entering directory: http://10.10.10.100/includes/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
---- Entering directory: http://10.10.10.100/blog/config/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
---- Entering directory: http://10.10.10.100/blog/content/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
---- Entering directory: http://10.10.10.100/blog/docs/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
---- Entering directory: http://10.10.10.100/blog/flash/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
---- Entering directory: http://10.10.10.100/blog/images/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
---- Entering directory: http://10.10.10.100/blog/interface/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
---- Entering directory: http://10.10.10.100/blog/languages/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
---- Entering directory: http://10.10.10.100/blog/scripts/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
---- Entering directory: http://10.10.10.100/blog/themes/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
-----------------
END_TIME: Fri Aug 23 05:45:16 2019
DOWNLOADED: 9224 - FOUND: 30

```

Dirb has revelead additional infomration like: there is login functionality, registration functionality, and some endpoint called activate. Additionally there is a whole directory blog, hosting a bloggin functionality.


### Testing and Exploitation

Further testing will be handled on the http website running on port 80 tcp. Then the communication was intercepted with the usage of local web proxy Burp Suite. This is how main page looks like.

![Login](../master/static/pwnos_login.jpg)

Since we have identified that the user john is valid, we may try to login to the application by sending the following POST request.

```
POST /login.php HTTP/1.1
Host: 10.10.10.100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://10.10.10.100/login.php
Cookie: PHPSESSID=nkgdfc292mqp70d0l6h7l4mr15
Connection: close
Upgrade-Insecure-Requests: 1
Content-Type: application/x-www-form-urlencoded
Content-Length: 60

email=test%40test.com&pass=test&submit=Login&submitted=TRUE


```

We supply the following request to sqlmap to test for SQL injection vulnerability.
Sqlmap has detected the **email** parameter as vulnerable to SQL injection. With the usage of sqlmap, the attacker is able to retrive data from database.
Since, the SQL injection vulnerability was idetified the attacker would try to extract as much information as possible from the web application. For database dumping, there maybe be automated tool used called sqlmap. The sqlmap will dump all the neccassary data from the database. During the penetration testing there was the **users** table dumped.


![SQLmap](../master/static/pwnos_sqlmap.jpg)


![SQLmap](../master/static/pwnos_sqlmap2.jpg)

The hashes can be broken by bruteforce or dictionary attack. The hashing algorytm used to generate hashes is weak and it is not recommneded to use it.

Also the attacker might want to get interactive reverse shell to attempt privilage escalation on the system. Initially it is easy to get interactive shell with sqlmap tool.

![SQLmap](../master/static/pwnos_shell.jpg)

Then the attacker would try to execute payload to get full bash reverse tcp shell. The machine has python install. After executing python payload the attacker gets netcat reverse shell.


![SQLmap](../master/static/pwnos_reverse.jpg)


BLOG PART

### Appendix - Privilage Escalation

After achiveing low privilaged user shell in the OS. The attacker will look for privilage escalation. From the discovery phase we know that it is possible to run the kernel expoit, however it is recommened to look for wrongly configured services, cronjobs, processes with wrongly set permissions, setuid files since the kernel expoits might affect the avaiability of services.

The attacker found root password in /var/mysqli_connect.php file.

![SQLmap](../master/static/pwnos_rootpwd.jpg)

Then the attacker checked if the password was reused, for example in ssh service

![SQLmap](../master/static/pwnos_rootssh.jpg)

The privilage may have to be escalated other ways like:
- kernel exploits
- mysql running as root user


## Recommendations

Last chapter describes the recommendation for remediation of each discovered vulnerability. Additionally there has been some enhancement proposed to ensure the highest risk mitigation.

**1. SQL Injection**

Use prepared statements and parameterized queries. These are SQL statements that are sent to and parsed by the database server separately from any parameters. This way it is impossible for an attacker to inject malicious SQL.
Example using PDO (for any supported database driver):

```
$stmt = $pdo->prepare('SELECT * FROM employees WHERE name = :name');

$stmt->execute(array('name' => $name));
```

**2. Using Vulnerable Software**



**3. Weak Passwords**

Enforce password policy for the users. Do not allow users to create the account with weak passwords. Regulary audit user passwords.


**4.Cleartext Storage of Passwords**

Never store user passwords in cleartext. Use secure hashing functions with salt. For details refer to php guideline:
https://www.php.net/manual/en/faq.passwords.php

**5. Unecnrypted communication**

Implement strong TLS configuration, send senstive data only through encrypted channel. The tester recommends to apply TLS1.2+ (date: 22/08/2019). Also it is recommended to set up HSTS-HTTP header and add the flag secure to the sensitive cookie.


**6. Anti-Clickjacking not presents**

Apply the UI render restriction by adding X-Frame-Options header to each response. There should be following line added to httpd.conf

```
Header always append X-Frame-Options SAMEORIGIN
```

**7. Cookie without httponly flag**

Protect the senstive cookie by applying the flag HttpOnly. The flag should be append in the time for cookie creation in PHP code.


**8. Additional**

- Implement patch management policy. Regulary apply software updates. Upgrade Apache Webserver, PHP, Linux Kernel.

- Enable X-XSS-Protection Header

- Enable X-Content-Type-Options

- Use low privilaged user to run mysql service